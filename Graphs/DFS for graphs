The function is mostly recursive.


